<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="/favicon.ico?v=2" />

  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Manage AWS Saml Roles for G Suite Users &middot; Non-volatile Memory
    
  </title>

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p class="sidebar-quote">Nothing stands out so conspicuously, or remains so firmly fixed in the memory, as something which you have blundered.
    </p>
    <footer class="sidebar-quote-attribution">â€” Marcus Tullius Cicero</footer>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/">Home</a>
    <a class="sidebar-nav-item " href="/post">Posts</a>

    
    
      
    
      
    
      
    
      
    
      
    
      
    
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2018. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Non-volatile Memory</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">Manage AWS Saml Roles for G Suite Users</h1>
  <span class="post-date">Sep 11, 2018</span>
  

<p>I recently setup G Suite (aka Google Apps for Work) as the SAML IdP for my
personal AWS account following <a href="https://aws.amazon.com/blogs/security/how-to-set-up-federated-single-sign-on-to-aws-using-google-apps/">these instructions</a>.  Once it was done, I had
a very simple way to log into my AWS console using my existing G Suite credentials.</p>

<p><img src="https://dmhnzl5mp9mj6.cloudfront.net/security_awsblog/images/WD_2.png" alt="SAML
architecture" /></p>

<p>Now I no longer need to remember my IAM user password (well, it was in a password
manager, but it&rsquo;s one less thing) and I get the additional benefit of my G
Suite-configured MFA settings.  I like this a lot better than the MFA that
AWS provides for IAM users because Google&rsquo;s <a href="https://gsuiteupdates.googleblog.com/2017/10/making-google-prompt-primary-choice-for-2sv.html">2-Step verification phone prompts</a> make MFA so simple.</p>

<h2 id="api-access">API Access</h2>

<p>However, I had one more requirement for IAM users- AWS API access.  Thankfully,
someone has <a href="https://github.com/cevoaustralia/aws-google-auth">already created a solution</a>
for getting temporary AWS Access Keys using the Google Apps SAML provider.  You
simply provide a few key pieces of information to the tool&rsquo;s command line
interface:</p>

<pre><code>aws-google-auth -u user@yourgsuitedomain.com -I I3892idw, -S 834286658791 -R us-east-1 -d 3600 -a
</code></pre>

<p>This tool even triggers the MFA phone prompts I&rsquo;ve configured for my account.
The <code>-a</code> flag causes it to prompt for selection of the desired AWS role, so if
you&rsquo;ve configured multiple roles for a G Suite user you can select which one you
want the access keys for.  The access keys are then written to your AWS
credentials file under the <code>sts</code> profile name (though there is a flag to specify
a different name).</p>

<h2 id="roles-for-identity-federation">Roles for Identity Federation</h2>

<p>Now that I had my G Suite user configured with a custom schema and an AWS IAM
role (see the first link, about one third down the page), I wanted an simple way
to add and remove roles from my user account.</p>

<p>I am obsessed with the principle of least privilege, so I am always crafting
new IAM policies and wanting to test them out.
<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-iam-role.html">CloudFormation</a>
is the best way quickly create and destroy IAM policies and
<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-idp_saml.html">roles for Identity Federation</a></p>

<p>Here&rsquo;s an example CloudFormation template I was using test limiting of access to
EC2 Instance creation:</p>

<pre><code class="language-yaml">AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Resources:
  DevTeamEC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: &quot;2012-10-17&quot;
        Statement:
          -
            Effect: &quot;Allow&quot;
            Action: &quot;sts:AssumeRoleWithSAML&quot;
            Principal:
              Federated: !Sub &quot;arn:aws:iam::${AWS::AccountId}:saml-provider/GoogleApps&quot;
            Condition:
              StringEquals:
                SAML:aud: https://signin.aws.amazon.com/saml
      Path: &quot;/&quot;
      Policies:
        -
          PolicyName: &quot;DevTeamStopStartTerminate&quot;
          PolicyDocument:
            Version: &quot;2012-10-17&quot;
            Statement:
              -
                Sid: &quot;AllowDevTeamStartStopTerminate&quot;
                Effect: &quot;Allow&quot;
                Action: 
                - &quot;ec2:StopInstances&quot;
                - &quot;ec2:StartInstances&quot;
                - &quot;ec2:TerminateInstances&quot;
                Resource: &quot;*&quot;
                Condition:
                  StringEquals:
                    &quot;ec2:ResourceTag/Department&quot;: &quot;Dev Team A&quot;
Outputs:
  RoleName:
    Description: &quot;The ARN of the role created&quot;
    Value: !GetAtt DevTeamEC2Role.Arn
</code></pre>

<p>With that template, I can quickly create the role and policy I want to test:</p>

<pre><code>aws --profile sts cloudformation create-stack --stack-name devteam --template-body file://teststopstart.yaml --capabilities CAPABILITY_IAM
... after a minute or so ...
aws --profile sts cloudformation describe-stacks --stack-name devteam
</code></pre>

<p>The <code>describe-stacks</code> API call will give me the name of the role created.  Now
how do I quickly add it to my G Suite user?</p>

<h2 id="multiple-roles">Multiple Roles</h2>

<p>I began with <a href="https://developers.google.com/admin-sdk/directory/v1/quickstart/python">the code here</a>
which uses the G Suite Directory API to list out
users in my G Suite domain and then modified it to patch the custom schema (the
one added when the identity federation was setup.  <a href="https://github.com/jcaxmacher/google-cloud-aws-role-helper">The command line tool I
created</a> adds or
removes roles to the given user.</p>

<p>It requires some secret OAuth information, so I stored those in AWS Secrets Manager
and the command line tool downloads them right before making the G Suite
Directory API calls.  For example, this invocation adds the role <code>ServerlessDev</code>
(it&rsquo;s name in AWS) to my user <code>frank@custom.com</code>:</p>

<pre><code>python modify_roles.py sts GoogleApps frank@custom.com ADD ServerlessDev
</code></pre>

<p>Now, I can quickly create roles and policies for test and just as quickly add
them to my G Suite user.  Then it&rsquo;s back to the <code>aws-google-auth</code> tool to get
temporary access keys for that role.</p>

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
	<script>
		(function(f, a, t, h, o, m){	a[h]=a[h]||function(){
				(a[h].q=a[h].q||[]).push(arguments)
				};
				o=f.createElement('script'),
					m=f.getElementsByTagName('script')[0];
				o.async=1; o.src=t; o.id='fathom-script';
				m.parentNode.insertBefore(o,m)
		})(document, window, '//analytics.nvram.io/tracker.js', 'fathom');
fathom('set', 'siteId', 'XYWDE');
fathom('trackPageview');
	</script>
	

	<script type="text/javascript">
		 var quotes = [
			       {'quote': 'Nothing stands out so conspicuously, or remains so firmly fixed in the memory, as something which you have blundered.',
				              'attribution': 'Marcus Tullius Cicero'},
			       {'quote': 'Time moves in one direction, mery in another.',
				              'attribution': 'William Gibson'},
			       {'quote': 'If you wish to forget anything on the spot, make a note that this thing is to be remembered.',
				              'attribution': 'Edgar Allan Poe'},
			       {'quote': 'Just as food eaten without appetite is a tedious nourishment, so does study without zeal damage the memory by not assimilating whatit absorbs.',
				              'attribution': 'Leonardo da Vinci'},
			      {'quote': 'A clear conscience is the sure sign of a bad memory.',
				             'attribution': 'Mark Twain'},
			       {'quote': 'I thik it is all a matter of love: the more you love a memory, the stronger d stranger it is.',
				              'attribution': 'Vladimir Nabokov'},
			       {'quoe': 'There was a long hard time when I kept far from me the remembrance of what I had thrown away when I was quite ignorant of its worth.',
				              'attribution': 'harles Dickens, Great Expectations'},
			       {'quote': 'Every man\'s memory is his private literature.',
				              'attribution': 'Aldous Huxley'},
			       {'quote': 'Only those with no memory insist on their originality.',
				              'attribution': 'Coco Chanel'},
			       {'quote': 'Footflls echo in the memory<br>Down the passage we did not take<br>Towards the door we never opened<br>Into the rose garden. My words echo<br>Thus, in your mind',
				              'attribution': 'T.S. Eliot, Four Quartets'}
			     ];
    window.onload = function() {
	          var millisecondsThisYear = (new Date()) - (new Date((new Date()).getFullYear(), 0, 0));
	         var millisecondsInDay = 1000 * 60 * 60 * 24;
	          var dayOfTheYear = Math.floor(millisecondsThisYear / millisecondsInDay);
	          var quote = quotes[dayOfTheYear % quotes.length];
	          document.querySelector('.sidebar-quote').inerHTML = quote['quote'];
	          document.querySelector('.sidebar-quote-attribution').innerHTML = 'â€” ' + quote['attribution'];
	        }
	</script>

  </body>
</html>

